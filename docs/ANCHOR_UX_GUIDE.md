# Anchor-UX System Guide

## –û–±–∑–æ—Ä

Anchor-UX - —ç—Ç–æ –Ω–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –¥–ª—è Teo Bot, –∫–æ—Ç–æ—Ä–∞—è —Ä–µ–∞–ª–∏–∑—É–µ—Ç –∫–æ–Ω—Ü–µ–ø—Ü–∏—é –µ–¥–∏–Ω–æ–≥–æ "—è–∫–æ—Ä–Ω–æ–≥–æ" —Å–æ–æ–±—â–µ–Ω–∏—è. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–µ—Ç —Å –±–æ—Ç–æ–º —á–µ—Ä–µ–∑ –æ–¥–Ω–æ –æ—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –¥–µ–π—Å—Ç–≤–∏–∏.

## –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

### 1. –ï–¥–∏–Ω—ã–π Anchor
- –ü—Ä–∏ `/start` –∏–ª–∏ –≤—Ö–æ–¥–µ –≤ —Ä–∞–∑–¥–µ–ª –±–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç/–≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ä–æ–≤–Ω–æ –æ–¥–Ω–æ –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (Anchor)
- –õ—é–±–æ–π —ç–∫—Ä–∞–Ω = `editMessageText` / `editMessageMedia` —Ç–æ–≥–æ –∂–µ `message_id`
- –ï—Å–ª–∏ Anchor –∏—Å—á–µ–∑ (—É–¥–∞–ª—ë–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º) ‚Äî –±–æ—Ç —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π Anchor

### 2. –ò–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫–∏ –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π –≤–≤–æ–¥
- –õ—é–±–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `callback_query`
- –ë–æ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –æ—Ç–≤–µ—á–∞–µ—Ç `answerCallbackQuery` ‚â§ 2 —Å–µ–∫
- –í—Å–µ `callback_data` ‚Äî –∫–æ—Ä–æ—Ç–∫–∏–µ —Ç–æ–∫–µ–Ω—ã (‚â§ 64B) + —Å–µ—Ä–≤–µ—Ä–Ω—ã–π state

### 3. –°–≤–æ–±–æ–¥–Ω—ã–π –≤–≤–æ–¥ + "—Ä–µ–∂–∏–º –æ–∂–∏–¥–∞–Ω–∏—è"
- –ë–æ—Ç –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ `AWAITING_INPUT(type=...)`
- –ü–æ–∫–∞ –∞–∫—Ç–∏–≤–µ–Ω `AWAITING_INPUT`:
  - –ª—é–±–æ–µ –≤—Ö–æ–¥—è—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–∞—Ä—Å–∏—Ç—Å—è –ø–æ –æ–∂–∏–¥–∞–µ–º–æ–º—É —Ç–∏–ø—É
  - –ø—Ä–∏ —É—Å–ø–µ—Ö–µ ‚Äî –¥–µ–π—Å—Ç–≤–∏–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–¥–∞–ª—è–µ—Ç—Å—è
  - –ø—Ä–∏ –Ω–µ—É—Å–ø–µ—Ö–µ ‚Äî –±–æ—Ç –æ–±—ä—è—Å–Ω—è–µ—Ç –æ—à–∏–±–∫—É, –æ—Å—Ç–∞–≤–ª—è—è `AWAITING_INPUT` –∞–∫—Ç–∏–≤–Ω—ã–º

### 4. –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–º–µ—Å—Ç–æ "–∑–∞—Å–æ—Ä—è—Ç—å —á–∞—Ç"
- –õ—é–±—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ ‚Äî `edit` —Ç–µ–∫—É—â–µ–≥–æ Anchor
- –ò—Å–∫–ª—é—á–µ–Ω–∏–µ: –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏/–æ—à–∏–±–∫–∏ —á–µ—Ä–µ–∑ `answerCallbackQuery`

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —ç–∫—Ä–∞–Ω–∞ (Anchor)

```
‚è≥ –ñ–¥—É: —Å—Å—ã–ª–∫—É –Ω–∞ Google –¢–∞–±–ª–∏—Ü—É

**–§–∏–Ω–∞–Ω—Å—ã ‚Üí –ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö**

–ü–æ–¥–∫–ª—é—á–∏—Ç–µ Google –¢–∞–±–ª–∏—Ü—É –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤.

_–û–±–Ω–æ–≤–ª–µ–Ω–æ: 2024-12-26 11:30_

[üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É] [‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏]
[üîô –ù–∞–∑–∞–¥] [üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é]
```

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã:
- **–ó–∞–≥–æ–ª–æ–≤–æ–∫** (–≥–¥–µ —è?)
- **–û—Å–Ω–æ–≤–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ** (—á—Ç–æ —Å–¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ?)
- **–°—Ç–∞—Ç—É—Å/—Ç–∞–π–º—Å—Ç–∞–º–ø** (–Ω–∞—Å–∫–æ–ª—å–∫–æ –∞–∫—Ç—É–∞–ª—å–Ω–æ?)
- **–ö–Ω–æ–ø–∫–∏**: –î–µ–π—Å—Ç–≤–∏–µ, –ù–∞–∑–∞–¥, –û—Ç–º–µ–Ω–∞/–ó–∞–∫—Ä—ã—Ç—å, –ü–æ–º–æ—â—å
- **–ï—Å–ª–∏ –∞–∫—Ç–∏–≤–µ–Ω –≤–≤–æ–¥** ‚Äî –≤ —à–∞–ø–∫–µ —è–≤–Ω–æ ¬´–ñ–¥—É: <—á—Ç–æ>¬ª

## –ù–∞–≤–∏–≥–∞—Ü–∏—è

### –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –Ω–∞ –∫–∞–∂–¥–æ–º —ç–∫—Ä–∞–Ω–µ:
- **üîô –ù–∞–∑–∞–¥** - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É —ç–∫—Ä–∞–Ω—É
- **üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é** - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é

### –ò—Å—Ç–æ—Ä–∏—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏:
- –°–∏—Å—Ç–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏—Å—Ç–æ—Ä–∏—é —ç–∫—Ä–∞–Ω–æ–≤ (–¥–æ 10 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö)
- –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏–π —ç–∫—Ä–∞–Ω
- –ï—Å–ª–∏ –∏—Å—Ç–æ—Ä–∏–∏ –Ω–µ—Ç - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é

## –¢–∏–ø—ã –≤–≤–æ–¥–∞

### –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ç–∏–ø—ã:
- `text` - —Ç–µ–∫—Å—Ç (–Ω–∞–∑–≤–∞–Ω–∏–µ, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π)
- `url` - —Å—Å—ã–ª–∫–∞ (Google Sheets)
- `number` - —á–∏—Å–ª–æ (—Å—É–º–º–∞, –ª–∏–º–∏—Ç)
- `date` - –¥–∞—Ç–∞ (YYYY-MM-DD)
- `month` - –º–µ—Å—è—Ü (YYYY-MM)
- `time` - –≤—Ä–µ–º—è (HH:MM)
- `currency` - –≤–∞–ª—é—Ç–∞

### –í–∞–ª–∏–¥–∞—Ü–∏—è:
- –ö–∞–∂–¥—ã–π —Ç–∏–ø –∏–º–µ–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é
- –ü—Ä–∏ –æ—à–∏–±–∫–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ–¥—Å–∫–∞–∑–∫–∞ —Å –ø—Ä–∏–º–µ—Ä–æ–º
- –û–∂–∏–¥–∞–Ω–∏–µ –≤–≤–æ–¥–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω—ã–º

## –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º

### –°–µ—Å—Å–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
```python
UserSession:
- user_id: int
- chat_id: int
- anchor_message_id: Optional[int]
- current_screen: Optional[ScreenState]
- awaiting_input: Optional[AwaitingInput]
- history_stack: List[ScreenState]
- last_activity: datetime
- nonce: str  # –¥–ª—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
```

### –°–æ—Å—Ç–æ—è–Ω–∏–µ —ç–∫—Ä–∞–Ω–∞:
```python
ScreenState:
- screen_id: str
- params: Dict[str, Any]
- title: str
- content: str
- status: str
- keyboard: List[List[Dict[str, str]]]
- created_at: datetime
```

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞:
```bash
python3 run_anchor_bot.py
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
```bash
python3 test_anchor_bot.py
```

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–π–ª—ã:
- `src/utils/anchor_ux.py` - –æ—Å–Ω–æ–≤–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ Anchor-UX
- `src/utils/anchor_helpers.py` - –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
- `src/core/anchor_teo_bot.py` - –æ—Å–Ω–æ–≤–Ω–æ–π –±–æ—Ç —Å Anchor-UX
- `src/core/anchor_main.py` - —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –°–æ–∑–¥–∞–Ω–∏–µ —ç–∫—Ä–∞–Ω–∞:
```python
from src.utils.anchor_ux import ScreenState

screen = ScreenState(
    screen_id="weather_menu",
    params={},
    title="üå§ –ü–æ–≥–æ–¥–∞",
    content="–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
    status="",
    keyboard=[
        [{"text": "üå§ –¢–µ–∫—É—â–∞—è –ø–æ–≥–æ–¥–∞", "callback_data": "current_weather"}],
        [{"text": "üìÖ –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 3 –¥–Ω—è", "callback_data": "forecast"}]
    ],
    created_at=datetime.now()
)

await show_screen(update, context, screen)
```

### –û–∂–∏–¥–∞–Ω–∏–µ –≤–≤–æ–¥–∞:
```python
from src.utils.anchor_ux import InputType

anchor_ux_manager.set_awaiting_input(
    user_id, chat_id,
    InputType.URL,
    "—Å—Å—ã–ª–∫—É –Ω–∞ Google –¢–∞–±–ª–∏—Ü—É",
    context={"finance_sheet": True}
)
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞:
```python
async def handle_finance_sheet_url(update, context, url):
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ URL
    await FinanceInterface.handle_sheet_url_input(update, context, url)
    
    # –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    screen = ScreenState(...)
    await show_screen(update, context, screen)
```

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### "Message is not modified":
- –°–∏—Å—Ç–µ–º–∞ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Ö–µ—à —ç–∫—Ä–∞–Ω–∞ –ø–µ—Ä–µ–¥ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- –ù–µ –ø—ã—Ç–∞–µ—Ç—Å—è "—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–º –∂–µ"

### "Message to edit not found":
- –°—á–∏—Ç–∞–µ—Ç Anchor –ø–æ—Ç–µ—Ä—è–Ω–Ω—ã–º
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–π Anchor –∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –ø–æ—Ç–æ–∫

### –ü–æ—Ç–µ—Ä—è —Å–µ—Ç–∏/–¥–æ–ª–≥–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:
- –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ –æ—Ç–≤–µ—á–∞–µ—Ç `answerCallbackQuery("–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é...")`
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç "—Å–ø–∏–Ω–Ω–µ—Ä-—ç–∫—Ä–∞–Ω" –∏ –∑–∞–º–µ–Ω—è–µ—Ç –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### Callback-data:
- –ö–æ—Ä–æ—Ç–∫–∏–µ —Ç–æ–∫–µ–Ω—ã (‚â§ 64B)
- –ù–∏–∫–∞–∫–∏—Ö PII/–∑–Ω–∞—á–∏–º—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- –°–µ—Ä–≤–µ—Ä –∏–∑–≤–ª–µ–∫–∞–µ—Ç –ø–æ–ª–Ω—ã–π state –ø–æ –∫–ª—é—á—É

### –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å:
- –õ—é–±–æ–π action –∏–º–µ–µ—Ç nonce/–≤–µ—Ä—Å–∏—é
- –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –∫–ª–∏–∫–∏/–¥—É–±–ª—å —Å–æ–±—ã—Ç–∏–π ‚Üí –±–µ–∑–æ–ø–∞—Å–Ω–æ –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è

### Rate-limit:
- –ê–Ω—Ç–∏-—Å–ø–∞–º –Ω–∞ —Å–≤–æ–±–æ–¥–Ω—ã–π –≤–≤–æ–¥
- –¢–∞–π–º–∞—É—Ç—ã –Ω–∞ AWAITING_INPUT (5 –º–∏–Ω—É—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ:
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—Ä–∞–Ω–Ω—ã—Ö —ç–∫—Ä–∞–Ω–æ–≤ (30‚Äì60 —Å–µ–∫)
- –ì—Ä–∞—Ü–∏–æ–∑–Ω–∞—è –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—è –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤

### –û—á–∏—Å—Ç–∫–∞:
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö —Å–µ—Å—Å–∏–π (24 —á–∞—Å–∞)
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ (10 —ç–∫—Ä–∞–Ω–æ–≤)

## –ú–∏–≥—Ä–∞—Ü–∏—è —Å —Å—Ç–∞—Ä–æ–π —Å–∏—Å—Ç–µ–º—ã

### –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:
- –°–∏—Å—Ç–µ–º–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–∞ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞–º–∏
- –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –ø–æ –º–æ–¥—É–ª—è–º
- Fallback –Ω–∞ —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
- –ï–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–π UX
- –ú–µ–Ω—å—à–µ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç–µ
- –õ—É—á—à–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è
- –ë–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫





