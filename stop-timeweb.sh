#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ Teo Bot –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ Timeweb
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./stop-timeweb.sh

set -e

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
log() {
    echo -e "${GREEN}[$(date +'%Y-%m-%d %H:%M:%S')] $1${NC}"
}

warn() {
    echo -e "${YELLOW}[$(date +'%Y-%m-%d %H:%M:%S')] WARNING: $1${NC}"
}

error() {
    echo -e "${RED}[$(date +'%Y-%m-%d %H:%M:%S')] ERROR: $1${NC}"
}

info() {
    echo -e "${BLUE}[$(date +'%Y-%m-%d %H:%M:%S')] INFO: $1${NC}"
}

SERVER_IP="62.113.36.171"

log "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é Teo Bot –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ Timeweb: $SERVER_IP"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
log "–ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É..."
if ! ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no root@$SERVER_IP 'echo "SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"' 2>/dev/null; then
    error "‚ùå –ù–µ —É–¥–∞–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É $SERVER_IP"
    error "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:"
    error "1. –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞"
    error "2. SSH –∫–ª—é—á–∏"
    error "3. IP –∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞"
    exit 1
fi

log "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"

# –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É –∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–æ—Ç–∞
ssh -o StrictHostKeyChecking=no root@$SERVER_IP << 'EOF'
    echo "=== –û–°–¢–ê–ù–û–í–ö–ê TEO BOT ==="
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞ –ø–µ—Ä–µ–¥ –æ—Å—Ç–∞–Ω–æ–≤–∫–æ–π
    echo "üìä –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞ –ø–µ—Ä–µ–¥ –æ—Å—Ç–∞–Ω–æ–≤–∫–æ–π:"
    if systemctl is-active teo-bot.service &> /dev/null; then
        echo "‚úÖ –°–µ—Ä–≤–∏—Å –∑–∞–ø—É—â–µ–Ω"
    else
        echo "‚ùå –°–µ—Ä–≤–∏—Å –Ω–µ –∑–∞–ø—É—â–µ–Ω"
        exit 0
    fi
    
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º systemd —Å–µ—Ä–≤–∏—Å
    echo -e "\nüõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é systemd —Å–µ—Ä–≤–∏—Å..."
    systemctl stop teo-bot.service
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–µ—Ä–≤–∏—Å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
    echo -e "\nüìä –ü—Ä–æ–≤–µ—Ä—è—é —Å—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏:"
    if systemctl is-active teo-bot.service &> /dev/null; then
        echo "‚ùå –°–µ—Ä–≤–∏—Å –≤—Å–µ –µ—â–µ –∑–∞–ø—É—â–µ–Ω"
        exit 1
    else
        echo "‚úÖ –°–µ—Ä–≤–∏—Å —É—Å–ø–µ—à–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    fi
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ Python —Å –±–æ—Ç–æ–º
    echo -e "\nüìä –ü—Ä–æ–≤–µ—Ä—è—é –ø—Ä–æ—Ü–µ—Å—Å—ã Python:"
    if pgrep -f "python.*main.py" > /dev/null; then
        echo "‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω—ã –ø—Ä–æ—Ü–µ—Å—Å—ã Python, –∑–∞–≤–µ—Ä—à–∞—é –∏—Ö..."
        pkill -f "python.*main.py" || true
        sleep 2
    else
        echo "‚úÖ –ü—Ä–æ—Ü–µ—Å—Å—ã Python –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
    fi
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è)
    echo -e "\nüìä –ü—Ä–æ–≤–µ—Ä—è—é Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã:"
    if command -v docker-compose &> /dev/null; then
        cd /root/teo-bot
        if [ -f "docker-compose.yml" ]; then
            echo "üìã –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
            docker-compose down || true
        fi
    fi
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤
    echo -e "\nüìä –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ –ø–æ—Å–ª–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏:"
    echo "CPU –∏ –ø–∞–º—è—Ç—å:"
    top -bn1 | head -5
    
    echo -e "\n=== –ë–û–¢ –£–°–ü–ï–®–ù–û –û–°–¢–ê–ù–û–í–õ–ï–ù ==="
EOF

if [ $? -eq 0 ]; then
    log "‚úÖ Teo Bot —É—Å–ø–µ—à–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ Timeweb"
    log "üí° –î–ª—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ: ./start-timeweb.sh"
    log "üí° –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ: ./check-timeweb.sh"
else
    error "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –±–æ—Ç–∞"
    exit 1
fi
